<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Контроль Веса и Питания v2.1 (Recovery)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal.active { display: flex; }
        input[type="number"]::-webkit-inner-spin-button { display: none; }
        .tab-active { border-bottom: 3px solid #4f46e5; color: #4f46e5; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-10">

    <nav class="bg-indigo-700 text-white p-4 shadow-xl sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="font-bold text-lg leading-tight">Мой Дневник</h1>
            <div class="flex gap-2">
                <button onclick="openAnalytics()" class="bg-indigo-900 px-3 py-1.5 rounded-lg text-xs font-semibold uppercase tracking-wider">Аналитика</button>
                <button onclick="exportToExcel()" class="bg-emerald-600 px-3 py-1.5 rounded-lg text-xs font-semibold uppercase tracking-wider">Excel</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4">
        <div id="recoveryAlert" class="hidden mb-4 p-3 bg-green-100 border border-green-200 text-green-700 rounded-xl text-sm font-medium">
            ✅ Данные из предыдущей версии успешно восстановлены!
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-md mb-6 border border-slate-200">
            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Выбрать дату</label>
            <div class="flex gap-2">
                <input type="date" id="newDateInput" class="flex-1 border-slate-200 border-2 p-2.5 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                <button onclick="addDay()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all">Добавить</button>
            </div>
        </div>

        <div class="overflow-x-auto bg-white rounded-2xl shadow-xl border border-slate-200">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-50 border-b border-slate-200" id="tableHeader">
                        <th class="p-4 border-r border-slate-200 min-w-[140px] text-slate-400 font-bold uppercase text-[10px] tracking-widest">Параметры</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr id="rowWeight" class="border-b border-slate-100">
                        <td class="p-4 font-bold bg-slate-50 border-r border-slate-200 text-sm text-slate-700">Вес (У / В)</td>
                    </tr>
                    <tr id="rowFood">
                        <td class="p-4 font-bold bg-slate-50 border-r border-slate-200 text-sm text-slate-700">Еда (ккал)</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="foodModal" class="modal items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[85vh] overflow-hidden flex flex-col shadow-2xl">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h2 class="text-xl font-black text-slate-800" id="modalTitle">Питание</h2>
                <button onclick="closeModal()" class="text-slate-400 text-3xl">&times;</button>
            </div>
            <div id="foodItemsContainer" class="p-6 overflow-y-auto space-y-4 flex-1 bg-white"></div>
            <div class="p-6 border-t border-slate-100 bg-slate-50 space-y-4">
                <button onclick="addFoodRow()" class="w-full border-2 border-dashed border-indigo-300 text-indigo-600 py-3 rounded-2xl font-bold">+ Добавить строку</button>
                <div class="flex justify-between items-center px-2">
                    <span class="text-slate-500 font-bold uppercase text-xs">Итог:</span>
                    <span class="text-2xl font-black text-indigo-600"><span id="modalTotalKcal">0</span> <small class="text-sm font-normal text-slate-400">ккал</small></span>
                </div>
                <button onclick="saveFood()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold">Сохранить</button>
            </div>
        </div>
    </div>

    <datalist id="food-library"></datalist>

    <div id="analyticsModal" class="modal items-center justify-center p-2 backdrop-blur-md">
        <div class="bg-white rounded-3xl w-full max-w-5xl h-[90vh] overflow-y-auto p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black text-slate-800">Аналитика</h2>
                <button onclick="closeAnalytics()" class="text-3xl text-slate-300">&times;</button>
            </div>
            <div class="space-y-8">
                <div class="h-80 bg-slate-50 p-4 rounded-2xl"><canvas id="weightChart"></canvas></div>
                <div class="h-80 bg-slate-50 p-4 rounded-2xl"><canvas id="foodChart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        const FINAL_DB_KEY = 'health_tracker_final_storage';
        const OLD_KEYS = ['diet_db', 'weight_tracker_db'];

        const calorieLibrary = {
            "курица": 170, "грудка": 113, "котлета": 250, "рис": 130, "басмати": 130, "говядина": 250, 
            "масло": 717, "сливочное": 717, "брокколи": 34, "яйцо": 155, "хлеб": 250, "гречка": 132, 
            "рыба": 150, "творог": 100, "огурец": 15, "помидор": 18, "сыр": 350, 
            "печенье": 450, "протеиновое": 380, "сметана": 200, "молоко": 60
        };

        let db = { days: {}, library: {} };
        let activeDate = null;

        function migrateData() {
            let migrated = false;
            let currentData = localStorage.getItem(FINAL_DB_KEY);
            if (currentData) db = JSON.parse(currentData);

            OLD_KEYS.forEach(oldKey => {
                let oldData = localStorage.getItem(oldKey);
                if (oldData) {
                    let parsedOld = JSON.parse(oldData);
                    db.days = Object.assign({}, parsedOld.days || {}, db.days);
                    db.library = Object.assign({}, parsedOld.library || {}, db.library);
                    localStorage.removeItem(oldKey);
                    migrated = true;
                }
            });

            if (migrated) {
                localStorage.setItem(FINAL_DB_KEY, JSON.stringify(db));
                document.getElementById('recoveryAlert').classList.remove('hidden');
                setTimeout(() => document.getElementById('recoveryAlert').classList.add('hidden'), 5000);
            }
        }

        // Обновление выпадающего списка опций
        function updateDataList() {
            const list = document.getElementById('food-library');
            list.innerHTML = '';
            // Добавляем встроенную библиотеку
            Object.keys(calorieLibrary).forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                list.appendChild(opt);
            });
            // Добавляем пользовательскую библиотеку
            Object.keys(db.library).forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                list.appendChild(opt);
            });
        }

        function init() {
            migrateData();
            updateDataList();
            renderTable();
        }

        function save() {
            localStorage.setItem(FINAL_DB_KEY, JSON.stringify(db));
            updateDataList();
            renderTable();
        }

        function addDay() {
            const dateVal = document.getElementById('newDateInput').value;
            if (!dateVal) return;
            const formatted = dateVal.split('-').reverse().join('.');
            if (!db.days[formatted]) {
                db.days[formatted] = { morning: '', evening: '', food: [] };
                save();
            }
        }

        function deleteDay(date) {
            if(confirm(`Удалить ${date}?`)) {
                delete db.days[date];
                save();
            }
        }

        function renderTable() {
            const header = document.getElementById('tableHeader');
            const rowWeight = document.getElementById('rowWeight');
            const rowFood = document.getElementById('rowFood');

            header.innerHTML = '<th class="p-4 border-r border-slate-200 min-w-[140px] text-slate-400 font-bold uppercase text-[10px] tracking-widest">Параметры</th>';
            rowWeight.innerHTML = '<td class="p-4 font-bold bg-slate-50 border-r border-slate-200 text-sm text-slate-700">Вес (У / В)</td>';
            rowFood.innerHTML = '<td class="p-4 font-bold bg-slate-50 border-r border-slate-200 text-sm text-slate-700">Еда (ккал)</td>';

            const sortedDates = Object.keys(db.days).sort((a, b) => {
                return new Date(b.split('.').reverse().join('-')) - new Date(a.split('.').reverse().join('-'));
            });

            sortedDates.forEach(date => {
                const th = document.createElement('th');
                th.className = 'p-4 border-r border-slate-200 min-w-[150px] relative group text-center bg-white';
                th.innerHTML = `<div class="text-indigo-600 font-black text-sm">${date}</div>
                    <button onclick="deleteDay('${date}')" class="text-red-400 text-[9px] font-bold uppercase hidden group-hover:block absolute w-full left-0 bottom-1">удалить</button>`;
                header.appendChild(th);

                const tdW = document.createElement('td');
                tdW.className = 'p-3 border-r border-slate-100';
                tdW.innerHTML = `<div class="flex gap-1">
                    <input type="number" step="0.1" value="${db.days[date].morning}" class="w-1/2 border-slate-100 border p-2 rounded-lg text-xs text-center" onchange="updateWeight('${date}', 'morning', this.value)">
                    <input type="number" step="0.1" value="${db.days[date].evening}" class="w-1/2 border-slate-100 border p-2 rounded-lg text-xs text-center" onchange="updateWeight('${date}', 'evening', this.value)">
                </div>`;
                rowWeight.appendChild(tdW);

                const tdF = document.createElement('td');
                tdF.className = 'p-3 border-r border-slate-100 text-center';
                const totalKcal = db.days[date].food.reduce((sum, item) => sum + (Number(item.kcal) || 0), 0);
                tdF.innerHTML = `<button onclick="openFood('${date}')" class="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-xl text-sm font-black w-full hover:bg-indigo-100 border border-indigo-100">
                    ${Math.round(totalKcal)}</button>`;
                rowFood.appendChild(tdF);
            });
        }

        function updateWeight(date, time, val) {
            db.days[date][time] = val;
            save();
        }

        function openFood(date) {
            activeDate = date;
            document.getElementById('modalTitle').innerText = `Еда: ${date}`;
            document.getElementById('foodItemsContainer').innerHTML = '';
            db.days[date].food.forEach((item, index) => addFoodRow(item, index));
            if(db.days[date].food.length === 0) addFoodRow();
            calculateModalTotal();
            document.getElementById('foodModal').classList.add('active');
        }

        function addFoodRow(item = {name: '', b: '', j: '', u: '', kcal: ''}) {
            const container = document.getElementById('foodItemsContainer');
            const div = document.createElement('div');
            div.className = "bg-slate-50 p-4 rounded-2xl border border-slate-200 relative";
            div.innerHTML = `
                <input type="text" value="${item.name}" list="food-library" placeholder="Описание блюда..." 
                    onchange="smartEstimate(this)" class="food-name w-full mb-3 p-3 border-slate-200 border-2 rounded-xl font-bold text-sm focus:outline-none">
                <div class="grid grid-cols-4 gap-2">
                    <input type="number" value="${item.b}" placeholder="Б" class="food-b w-full border border-slate-100 p-2 rounded-lg text-xs">
                    <input type="number" value="${item.j}" placeholder="Ж" class="food-j w-full border border-slate-100 p-2 rounded-lg text-xs">
                    <input type="number" value="${item.u}" placeholder="У" class="food-u w-full border border-slate-100 p-2 rounded-lg text-xs">
                    <input type="number" value="${item.kcal}" oninput="calculateModalTotal()" class="food-kcal w-full border border-indigo-100 p-2 rounded-lg text-xs font-black text-indigo-600 bg-white">
                </div>`;
            container.appendChild(div);
        }

        function smartEstimate(input) {
            const text = input.value;
            const parent = input.parentElement;
            
            // Если нашли в пользовательской библиотеке
            if(db.library[text]) {
                const lib = db.library[text];
                parent.querySelector('.food-b').value = lib.b; 
                parent.querySelector('.food-j').value = lib.j;
                parent.querySelector('.food-u').value = lib.u; 
                parent.querySelector('.food-kcal').value = lib.kcal;
                calculateModalTotal(); 
                return;
            }

            // Если нашли во встроенной (поиск по вхождению)
            const lowText = text.toLowerCase();
            let estKcal = 0; let found = false;
            Object.keys(calorieLibrary).forEach(key => {
                if (lowText.includes(key)) {
                    let weightMatch = lowText.match(/(\d+)\s*(г|гр)/);
                    let mult = weightMatch ? (parseInt(weightMatch[1]) / 100) : 1;
                    estKcal += calorieLibrary[key] * mult; found = true;
                }
            });
            if (found) { parent.querySelector('.food-kcal').value = Math.round(estKcal); calculateModalTotal(); }
        }

        function calculateModalTotal() {
            let total = 0;
            document.querySelectorAll('.food-kcal').forEach(input => total += (Number(input.value) || 0));
            document.getElementById('modalTotalKcal').innerText = Math.round(total);
        }

        function saveFood() {
            const rows = document.querySelectorAll('#foodItemsContainer > div');
            const foodData = [];
            rows.forEach(row => {
                const name = row.querySelector('.food-name').value; if(!name) return;
                const item = { 
                    name, 
                    b: row.querySelector('.food-b').value, 
                    j: row.querySelector('.food-j').value, 
                    u: row.querySelector('.food-u').value, 
                    kcal: row.querySelector('.food-kcal').value 
                };
                foodData.push(item); 
                // Сохраняем в библиотеку для будущих подсказок
                db.library[name] = item;
            });
            db.days[activeDate].food = foodData;
            save(); 
            closeModal();
        }

        function closeModal() { document.getElementById('foodModal').classList.remove('active'); }

        function openAnalytics() {
            document.getElementById('analyticsModal').classList.add('active');
            const dates = Object.keys(db.days).sort((a, b) => new Date(a.split('.').reverse().join('-')) - new Date(b.split('.').reverse().join('-')));
            const weights = dates.map(d => (Number(db.days[d].morning) + Number(db.days[d].evening)) / 2 || null);
            const kcals = dates.map(d => db.days[d].food.reduce((s, i) => s + (Number(i.kcal) || 0), 0));

            if(window.wChart) window.wChart.destroy();
            window.wChart = new Chart(document.getElementById('weightChart').getContext('2d'), {
                type: 'line', data: { labels: dates, datasets: [{ label: 'Вес (кг)', data: weights, borderColor: '#4f46e5', tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            if(window.fChart) window.fChart.destroy();
            window.fChart = new Chart(document.getElementById('foodChart').getContext('2d'), {
                type: 'bar', data: { labels: dates, datasets: [{ label: 'Ккал', data: kcals, backgroundColor: '#f97316' }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function closeAnalytics() { document.getElementById('analyticsModal').classList.remove('active'); }

        function exportToExcel() {
            const data = Object.keys(db.days).map(d => ({
                "Дата": d, "Вес У": db.days[d].morning, "Вес В": db.days[d].evening,
                "Ккал": db.days[d].food.reduce((s, i) => s + Number(i.kcal || 0), 0)
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Дневник");
            XLSX.writeFile(wb, `Diet_Data.xlsx`);
        }

        init();
    </script>
</body>
</html>
